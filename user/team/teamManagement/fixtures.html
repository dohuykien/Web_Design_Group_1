<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch thi đấu</title>
    <link rel="icon" type="logo.png" href="../images/logo.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link rel="stylesheet" href="/user/css/sidebar.css" />
    <link rel="stylesheet" href="/user/css/userheader.css" />
    <link rel="stylesheet" href="/user/css/userfooter.css" />

    <link rel="stylesheet" href="/user/team/teamManagement/css/managementNav.css" />
    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-family: Oswald, sans-serif; /* Default font */
        }
        body {
          background-color: white;
        }


        /*----------------------Layout-------------------------*/
        .container {
          display: flex;
          width: 100%;
        }

      /*content: list-league + footer */
      .content-wrapper {
        flex: 1;
        display: block;
        margin: 0;
        padding: 0;
        background-color: #ecf0f5;
      }
      .content {
        background-color: #ecf0f5;
      }
        /* list-league */
        .list-league {
            color: rgb(34, 34, 34);
            font-size: 24px;
            font-weight: normal;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            min-height: 70px;
        }
        .list-league_left {
          font-family: "Source Sans Pro", sans-serif !important;
        }
        .fa-solid.fa-check {
          color: #ff6f00;
          margin-right: 5px;
          font-size: 25px;
        }
        .list-league_left {
          flex-grow: 1;
        }

        /* Buttons styling moved to form layout section for consistency */

        /* Button styles in the header bar */

        .list-league i {
            margin-right: 5px;
        }


        /* Styling for the content box */
        .content-box {
            margin: 15px; /* Add some margin around the box */
            font-family: "Source Sans Pro", sans-serif;

        }

        .content-box label, .content-box input, .content-box select, .content-box button, .content-box option {
            font-family: "Source Sans Pro", sans-serif;
        }
        /* Styles specific to fixture list and dialog */

        /* Toolbar */
        .toolbar {
            display: flex;
            justify-content: flex-end; /* Align to right */
            align-items: center;
            gap: 10px; /* Space between filter and button */
        }
        .toolbar button, .toolbar select {
            color: white;
            padding: 6px 12px; /* Consistent padding */
            border-color: rgba(0, 0, 0, 0.25);
            border-style: solid;
            border-width: 0.8px;
            cursor: pointer;
            text-shadow: rgba(0, 0, 0, 0.25) 0px -1px 0px;
            box-shadow: 0px -1px 5px rgba(0, 0, 0, 0.1);
            vertical-align: middle; /* Ensure vertical alignment */
            font-size: 14px; /* Ensure consistent font size */
            line-height: 1.5; /* Consistent line height */
            height: auto; /* Allow height to be determined by padding/content */
            box-sizing: border-box;
            display: inline-flex; /* Align icon and text */
            align-items: center;
            gap: 5px;
            transition: background-color 0.15s ease-in-out; /* Smooth hover */
        }

    .create {
        background-color: rgb(76, 175, 80);
        }
    .create:hover {
        background-color: #4d9e51;
    }

    #fixture-filter {
        background-color: rgb(122, 75, 193);

    }
    #fixture-filter:hover {
        background-color: #6e18c4;
    }

    #fixture-filter option {
        background-color: white; /* Options often need explicit styling */
        color: #333;
    }

    /* Styling for the content box */
        /* Ensure correct font on elements inside content-box */
        .content-box, .content-box label, .content-box input, .content-box select, .content-box button, .content-box option, .content-box div {
            font-family: "Source Sans Pro", sans-serif;
        }

        /* Fixture List */
        .fixture-list-container {
            display: grid;
            gap: 20px; /* Space between cards */
            margin-top: 20px; /* Add space below toolbar if separate */
        }

        /* --- MODIFIED: Fixture Card Layout --- */
        .fixture-card {
            display: flex;
            align-items: center; /* Align items vertically */
            justify-content: space-between;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            /* border-left: 5px solid #007bff; */ /* Removed left border for cleaner look */
            flex-wrap: wrap; /* Allow actions section to wrap */
        }

        /* Wrapper for main horizontal content (Teams + Info) */
        .fixture-card .main-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%; /* Take full width initially */
            flex-grow: 1; /* Allow shrinking if needed */
        }


        .fixture-card .team {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 100px; /* Fixed width for team blocks */
            flex-shrink: 0; /* Prevent teams from shrinking too much */
        }

        .fixture-card .team img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-bottom: 5px;
            object-fit: cover;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
        }

        .fixture-card .team .team-name {
            font-size: 14px;
            font-weight: 600; /* Slightly bolder */
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .fixture-card .match-info {
            text-align: center;
            margin: 0 15px; /* Space between teams and info */
            flex-grow: 1; /* Take up available space */
            flex-shrink: 1; /* Allow info to shrink */
            min-width: 100px; /* Prevent excessive shrinking */
        }

        .fixture-card .match-info .time {
            font-size: 18px; /* Adjusted size */
            font-weight: bold;
            color: #e67e22;
            background-color: #f5f5f5;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 5px;
            display: inline-block;
        }

        .fixture-card .match-info .date {
            font-size: 13px; /* Adjusted size */
            color: #555;
            background-color: #f5f5f5;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        .fixture-card .match-info .venue {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            display: block; /* Ensure it takes its own line */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .fixture-card .match-info .venue i {
             margin-right: 4px;
        }

        /* --- MODIFIED: Actions Container below main content --- */
        .fixture-card .actions {
            display: flex;
            flex-direction: row; /* Buttons horizontal */
            gap: 10px; /* Space between buttons */
            width: 100%; /* Take full width */
            margin-top: 15px; /* Space above buttons */
            padding-top: 10px; /* Padding above buttons */
            border-top: 1px solid #eee; /* Separator line */
            justify-content: flex-end; /* Align buttons to the right */
            align-items: center;
        }

        /* --- MODIFIED: Action Button Style --- */
        .fixture-card .actions .btn {
            padding: 5px 10px;
            font-size: 12px;
            min-width: auto; /* Let content decide width */
            justify-content: center;
            flex-shrink: 0;
             /* Inherit general .btn styles */
        }

        /* General Button Styles (shared by dialog and card) */
        .btn {
            padding: 8px 15px;
            border: 1px solid transparent; /* Base border */
            border-radius: 3px; /* Consistent radius */
            cursor: pointer;
            font-size: 14px;
            text-align: center;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-family: "Source Sans Pro", sans-serif;
            line-height: 1.5;
            white-space: nowrap; /* Prevent wrapping */
             transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
        }
        .btn i { margin-right: 0; } /* Use gap */

        /* Specific Button Colors (AdminLTE Theme) */
        .btn-success {
            background-color: #00a65a;
            border-color: #008d4c;
            color: white;
        }

        .btn-success:hover {
            background-color: #008d4c;
        }

        .btn-primary {
            background-color: #3c8dbc;
            border-color: #367fa9;
            color: white;
        }

        .btn-primary:hover {
            background-color: #367fa9;
        }

        .btn-danger {
            background-color: #dd4b39;
            border-color: #d73925;
            color: white;
        }

        .btn-danger:hover {
            background-color: #d73925;
        }

        .btn-warning {
            background-color: #f39c12;
            border-color: #e08e0b;
            color: white;
        }

        .btn-warning:hover {
            background-color: #e08e0b;
        }

        .btn-info {
            background-color: #00c0ef;
            border-color: #00acd6;
            color: white;
        }

        .btn-info:hover {
            background-color: #00acd6;
        }

        .btn-secondary {
            background-color: #f4f4f4;
            color: #444;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background-color: #e7e7e7;
            border-color: #ccc;
        }

        .btn:disabled,
            .btn.disabled {
            background-color: #d2d6de;
            border-color: #d2d6de;
            color: #777;
            cursor: not-allowed;
            opacity: 0.65;
        }


        /* --- Dialog Styles (Mostly Unchanged) --- */
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .dialog-overlay.show {
            display: flex;
        }

        .dialog-content {
            background-color: #fff;
            padding: 25px 30px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            border-top: 3px solid #3c8dbc; /* Match primary button */
        }

        .dialog-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
            text-align: left;
            font-family: "Source Sans Pro", sans-serif;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 50px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }

        .close-button:hover {
            color: #666;
        }

        #fixture-form .form-group {
            margin-bottom: 15px;
        }

        #fixture-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
            color: #555;
        }

        #fixture-form input[type="text"],
        #fixture-form input[type="datetime-local"],
        #fixture-form select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
            box-sizing: border-box;
            line-height: 1.5;
        }

        #fixture-form input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        #fixture-form .teams-container,
        #fixture-form .location-container {
            display: flex;
            gap: 10px;
        }

        #fixture-form .teams-container > *,
        #fixture-form .location-container > * {
            flex: 1;
        }

        #fixture-form #teamBWrapper {
            flex: 1;
            position: relative; /* Keep for dropdown */
        }

        #fixture-form #teamBWrapper > * {
            width: 100%;
            box-sizing: border-box; /* Ensure consistency */
        }

        #fixture-form .form-actions {
            margin-top: 25px;
            text-align: right;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        #fixture-form .form-actions .btn {
            margin-left: 10px;
        }

        /* Placeholder styles */
        ::placeholder {
            color: #999;
            opacity: 1;
        }
        /* Add other vendor prefixes if needed */

        /* Styles for Searchable Dropdown */
        .search-results-dropdown {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            border-top: none;
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
            z-index: 1001;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 4px 4px;
            left: 0;
            top: 100%;
        }

        .search-result-item {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        color: #333;
        }

        .search-result-item:hover {
            background-color: #f0f0f0;
        }

        .search-result-item.no-results {
            font-style: italic;
            color: #888;
            cursor: default;
        }

        #fixture-form #teamBWrapper > input[type="text"] {
            width: 100%;
            box-sizing: border-box;
        }

        /* General adjustments for tablets and below */
        @media (max-width: 768px) {
            .list-league {
                flex-direction: column; /* Stack title and toolbar */
                align-items: stretch; /* Stretch items full width */
                gap: 15px; /* Add gap */
                padding-bottom: 15px; /* Add padding */
            }
            .list-league_left {
                text-align: center; /* Center title */
            }
            .toolbar {
                 width: 100%; /* Make toolbar full width */
                 justify-content: space-between; /* Space out filter/button */
                 flex-wrap: wrap; /* Allow wrapping if needed */
                 gap: 10px; /* Add gap */
            }
            .toolbar .filter-container, .toolbar div:last-child {
                flex-grow: 1; /* Allow filter/button container to grow */
                min-width: 150px; /* Prevent excessive squishing */
            }
             .toolbar button, .toolbar select {
                 width: 100%; /* Make filter/button take full width of their container */
                 justify-content: center; /* Center content in button/select */
             }

            /* Stack form elements in dialog */
            #fixture-form .teams-container,
            #fixture-form .location-container {
                flex-direction: column;
            }

            /* Make card actions centered and slightly smaller */
            .fixture-card .actions {
                 justify-content: center;
                 margin-top: 10px;
                 padding-top: 8px;
            }
            .fixture-card .actions .btn {
                 padding: 5px 10px; /* Slightly smaller buttons */
                 font-size: 13px;
            }
        }

        /* Specific adjustments to keep teams horizontal on smaller mobile */
        @media (max-width: 600px) {
            .fixture-card {
                padding: 10px; /* Reduce card padding */
            }

            .fixture-card .main-content {
                gap: 8px; /* Reduce gap between team/info */
                align-items: flex-start; /* Align to top maybe better */
            }

            .fixture-card .team {
                width: 75px; /* <<< Reduce team block width */
                flex-shrink: 0; /* Keep preventing shrinking */
            }

            .fixture-card .team img {
                width: 50px; /* <<< Reduce logo size */
                height: 50px;
                margin-bottom: 4px;
            }

            .fixture-card .team .team-name {
                font-size: 13px; /* <<< Reduce team name font size */
                line-height: 1.3; /* Adjust line height */
                /* Ensure text overflow is active */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .fixture-card .match-info {
                margin: 0 5px; /* Reduce horizontal margins */
                min-width: 70px; /* <<< Reduce minimum width */
                flex-grow: 1; /* Allow growth */
                 padding-top: 5px; /* Add slight top padding to align better */
            }

            .fixture-card .match-info .time {
                font-size: 16px; /* <<< Reduce time font size */
                padding: 3px 6px;
            }

            .fixture-card .match-info .date {
                font-size: 12px; /* <<< Reduce date font size */
                padding: 3px 6px;
            }
            .fixture-card .match-info .venue {
                font-size: 11px; /* <<< Reduce venue font size */
                margin-top: 4px;
                /* Ensure text overflow is active */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }

        /* Further adjustments for very small screens */
        @media (max-width: 420px) {
             .fixture-card .team {
                 width: 60px; /* Even smaller team block */
             }
             .fixture-card .team img {
                 width: 40px;
                 height: 40px;
             }
             .fixture-card .team .team-name {
                 font-size: 12px;
             }
             .fixture-card .match-info {
                 min-width: 50px;
                 margin: 0 3px;
             }
            .fixture-card .match-info .time { font-size: 14px; }
            .fixture-card .match-info .date { font-size: 11px; }
            .fixture-card .match-info .venue { font-size: 10px; }

            .fixture-card .actions {
                 gap: 5px; /* Less gap between buttons */
            }
             .fixture-card .actions .btn {
                 padding: 4px 6px; /* Even smaller buttons */
                 font-size: 11px;
                 gap: 3px; /* Less gap in buttons */
            }
        }
    </style>
</head>
<body>
    <header id="header-container" class="header">
        <!-- Header will be loaded here -->
    </header>


    <div class="container">
        <div id="sidebar-container">
             <!-- Sidebar will be loaded here -->
        </div>
        <div class="content-wrapper">
            <section class="content">
                <!-- Title and Action Buttons -->
                <div id="management-nav-placeholder">
                    <!-- Nav will load here -->
                </div>
                <div class="list-league">
                    <span class="list-league_left"><i class="fa-solid fa-check"></i>Lịch thi đấu </span>
                    <!-- Toolbar: Filter and Create Button -->
                    <div class="toolbar">
                        <div class="filter-container">
                            <select id="fixture-filter">
                                <option value="all">Tất cả lịch thi đấu</option>
                                <option value="internal">Đá nội bộ</option>
                                <option value="opponent">Đá đối</option>
                            </select>
                        </div>
                        <div>
                            <button id="create-fixture-btn" class="create">
                                <i class="fa-solid fa-plus"></i> Tạo mới
                            </button>
                        </div>
                    </div>
                </div>

                <div class="content-box">
                    

                    <!-- Fixture List Container -->
                    <div id="fixture-list" class="fixture-list-container">
                        <!-- Fixture cards will be loaded here by JavaScript -->
                    </div>

                    <!-- Create/Edit Fixture Dialog (Modal) -->
                    <div id="fixture-dialog" class="dialog-overlay">
                        <div class="dialog-content">
                            <span class="close-button">×</span>
                            <h3 id="dialog-title">Tạo trận đấu</h3>
                            <form id="fixture-form">
                                <input type="hidden" id="fixtureId"> <!-- Hidden field for editing -->

                                <div class="form-group">
                                    <label for="matchType">Loại trận đấu</label>
                                    <select id="matchType" required>
                                        <option value="" disabled selected>Chọn loại trận đấu</option>
                                        <option value="internal">Đá nội bộ</option>
                                        <option value="opponent">Đá đối</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Trận đấu</label>
                                    <div class="teams-container">
                                        <!-- Team A (Current Team) -->
                                        <input type="text" id="teamAName" placeholder="Đội nhà" readonly required>
                                        <input type="hidden" id="teamAId">
                    
                                        <!-- Team B (Conditional Input) -->
                                        <div id="teamBWrapper" style="position: relative;"> <!-- Added relative positioning for dropdown -->
                                            <!-- Input for Internal Match (Readonly) -->
                                            <input type="text" id="teamBInternalInput" placeholder="Đội khách (Nội bộ)" readonly style="display: none;">
                    
                                            <!-- Input for Opponent Search -->
                                            <input type="text" id="teamBSearchInput" placeholder="Tìm và chọn đối thủ..." autocomplete="off" style="display: none;">
                                            <div id="teamBResultsDropdown" class="search-results-dropdown">
                                                <!-- Search results will appear here -->
                                            </div>
                    
                                            <!-- Hidden input to store the actual selected Team B ID -->
                                            <input type="hidden" id="teamBId" required> <!-- Keep required for validation -->
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="scheduleDateTime">Lịch đá</label>
                                    <input type="datetime-local" id="scheduleDateTime" required>
                                </div>

                                <div class="form-group">
                                    <label>Khu vực</label>
                                    <div class="location-container">
                                        <select id="province">
                                            <option value="" disabled selected>Tỉnh thành</option>
                                            <!-- Add province options if needed, or leave as simple input -->
                                            <option value="TPHCM">TP. Hồ Chí Minh</option>
                                            <option value="Hanoi">Hà Nội</option>
                                            <option value="Danang">Đà Nẵng</option>
                                            <!-- Add more -->
                                        </select>
                                        <select id="district">
                                            <option value="" disabled selected>Chọn Quận/Huyện</option>
                                            <!-- Add district options dynamically based on province if needed -->
                                            <option value="Q1">Quận 1</option>
                                            <option value="Q3">Quận 3</option>
                                            <option value="CauGiay">Cầu Giấy</option>
                                            <!-- Add more -->
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="venue">Địa điểm sân thi đấu</label>
                                    <input type="text" id="venue" placeholder="Sân thi đấu" required>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">Lưu</button>
                                    <button type="button" class="btn btn-secondary close-dialog-btn">Hủy</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </section>

            <footer id="footer" class="footer">

            </footer>
  
        </div>
    </div>
    <script src="/user/js/sidebar.js"></script>
    <script src="/user/js/userheader.js"></script>
    <script src="/user/js/componentloader.js"></script>

    <script src="/user/team/teamManagement/js/managementNav.js"></script>

    <script> 
        document.addEventListener("DOMContentLoaded", () => {
          loadAndSetupManagementNav('management-nav-placeholder', 'managementNav.html');

        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
        // --- Globals and Data ---
        const currentUser = { id: 1 }; // Example user
        let currentTeam = null;
        let teams = [];
        let fixtures = [];

        // --- DOM Elements ---
        const fixtureListContainer = document.getElementById('fixture-list');
        const createFixtureBtn = document.getElementById('create-fixture-btn');
        const fixtureDialog = document.getElementById('fixture-dialog');
        const closeDialogButtons = document.querySelectorAll('.close-button, .close-dialog-btn');
        const fixtureForm = document.getElementById('fixture-form');
        const dialogTitle = document.getElementById('dialog-title');
        const fixtureFilter = document.getElementById('fixture-filter');

        // Form Fields
        const fixtureIdInput = document.getElementById('fixtureId');
        const matchTypeSelect = document.getElementById('matchType');
        const teamANameInput = document.getElementById('teamAName');
        const teamAIdInput = document.getElementById('teamAId');

        // *** Updated Team B Elements ***
        const teamBWrapper = document.getElementById('teamBWrapper');
        const teamBInternalInput = document.getElementById('teamBInternalInput'); // For internal display
        const teamBSearchInput = document.getElementById('teamBSearchInput'); // For opponent search
        const teamBResultsDropdown = document.getElementById('teamBResultsDropdown'); // Dropdown container
        const teamBIdInput = document.getElementById('teamBId'); // Hidden input for ID

        const scheduleDateTimeInput = document.getElementById('scheduleDateTime');
        const provinceSelect = document.getElementById('province');
        const districtSelect = document.getElementById('district');
        const venueInput = document.getElementById('venue');

        // --- Functions ---

        // Load data (Keep existing loadData and getDefaultTeams)
        function loadData() {
            const storedTeams = localStorage.getItem('teams');
            teams = storedTeams ? JSON.parse(storedTeams) : getDefaultTeams();
            const storedFixtures = localStorage.getItem('fixtures');
            fixtures = storedFixtures ? JSON.parse(storedFixtures) : [];
            if (!storedTeams) { localStorage.setItem('teams', JSON.stringify(teams)); }
        }
        function getDefaultTeams() { /* ... keep existing ... */
            console.warn("Using default team data. Clear localStorage 'teams' to reset if needed.");
            return [
                { id: 'team-1', userId: 1, teamName: 'My Awesome Team', managerName: 'Manager A', email: 'a@t.com', phone: '111', logo: 'https://via.placeholder.com/60/0000FF/FFFFFF?text=MAT', cover: '', homeKit: '', awayKit: '' },
                { id: 'team-2', userId: 2, teamName: 'Rival FC', managerName: 'Manager B', email: 'b@t.com', phone: '222', logo: 'https://via.placeholder.com/60/FF0000/FFFFFF?text=RFC', cover: '', homeKit: '', awayKit: '' },
                { id: 'team-3', userId: 1, teamName: 'Internal Lions', managerName: 'Manager C', email: 'c@t.com', phone: '333', logo: 'https://via.placeholder.com/60/008000/FFFFFF?text=IL', cover: '', homeKit: '', awayKit: '' },
                { id: 'team-4', userId: 3, teamName: 'City Strikers', managerName: 'Manager D', email: 'd@t.com', phone: '444', logo: 'https://via.placeholder.com/60/FFA500/FFFFFF?text=CS', cover: '', homeKit: '', awayKit: '' },
                { id: 'team-5', userId: 4, teamName: 'Saigon United', managerName: 'Manager E', email: 'e@t.com', phone: '555', logo: 'https://via.placeholder.com/60/800080/FFFFFF?text=SU', cover: '', homeKit: '', awayKit: '' },
            ];
        }
        function getCurrentTeamIdFromUrl() { /* ... keep existing ... */
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        function getTeamById(teamId) { /* ... keep existing ... */
            return teams.find(team => team.id === teamId);
        }
        function formatDateTime(dateTimeString) { /* ... keep existing ... */
            if (!dateTimeString) return { date: 'N/A', time: 'N/A' };
            try {
                const dateObj = new Date(dateTimeString);
                if (isNaN(dateObj)) return { date: 'Invalid Date', time: '' };
                const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };
                const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
                const time = dateObj.toLocaleTimeString('vi-VN', timeOptions);
                const date = dateObj.toLocaleDateString('vi-VN', dateOptions);
                return { date, time };
            } catch (error) { console.error("Error formatting date:", error); return { date: 'Error', time: '' }; }
        }
        function renderFixtures() {
            if (!currentTeam) { fixtureListContainer.innerHTML = '<p>Không tìm thấy thông tin đội bóng.</p>'; return; }
            fixtureListContainer.innerHTML = '';
            const filterValue = fixtureFilter.value;
            const relevantFixtures = fixtures.filter(fixture => {
                const isParticipant = fixture.teamAId === currentTeam.id || fixture.teamBId === currentTeam.id;
                if (!isParticipant) return false;
                if (filterValue === 'internal') return fixture.matchType === 'internal';
                else if (filterValue === 'opponent') return fixture.matchType === 'opponent';
                return true;
            });
            if (relevantFixtures.length === 0) { fixtureListContainer.innerHTML = '<p>Chưa có lịch thi đấu nào.</p>'; return; }

            relevantFixtures.forEach(fixture => {
                const teamA = getTeamById(fixture.teamAId);
                const teamB = getTeamById(fixture.teamBId);
                const { date, time } = formatDateTime(fixture.scheduleDateTime);
                const teamALogo = teamA?.logo || 'https://via.placeholder.com/60/cccccc/FFFFFF?text=N/A';
                const teamAName = teamA?.teamName || 'Không rõ';
                const teamBLogo = teamB?.logo || 'https://via.placeholder.com/60/cccccc/FFFFFF?text=N/A';
                const teamBName = teamB?.teamName || 'Không rõ';

                const card = document.createElement('div');
                card.className = 'fixture-card';

                // *** MODIFIED innerHTML for Stats button link ***
                card.innerHTML = `
                    <div class="main-content">
                        <div class="team team-a">
                             <img src="${teamALogo}" alt="${teamAName} logo">
                             <span class="team-name">${teamAName}</span>
                        </div>
                        <div class="match-info">
                             <div class="time">${time}</div>
                             <div class="date">${date}</div>
                             ${fixture.venue ? `<div class="venue"><i class="fa-solid fa-location-dot"></i> ${fixture.venue}</div>` : ''}
                        </div>
                        <div class="team team-b">
                             <img src="${teamBLogo}" alt="${teamBName} logo">
                             <span class="team-name">${teamBName}</span>
                         </div>
                     </div>
                     <div class="actions">
                        <button
                            class="btn btn-warning edit-btn"
                            data-id="${fixture.id}"
                            title="Sửa lịch thi đấu"
                        >
                            <i class="fa-solid fa-pencil"></i> Sửa
                        </button>
                        <button class="btn btn-danger delete-btn" data-id="${fixture.id}" title="Xóa lịch thi đấu">
                            <i class="fa-solid fa-trash"></i> Xoá
                        </button>
                        <a
                            href="fixturestats.html?fixtureId=${fixture.id}&id=${currentTeam.id}" {/* MODIFIED HERE */}
                            class="btn btn-info stats-btn"
                            title="Xem thông số trận đấu"
                        >
                            <i class="fa-solid fa-chart-simple"></i> Thông số
                        </a>
                     </div>`;
                fixtureListContainer.appendChild(card);
            });
        }
        function showDialog() { /* ... keep existing ... */
            fixtureDialog.classList.add('show');
            // Add listener to close dropdown when clicking outside
            document.addEventListener('click', handleOutsideClick, true);
        }
        function closeDialog() { /* ... keep existing ... */
            fixtureDialog.classList.remove('show');
            fixtureForm.reset();
            teamBResultsDropdown.style.display = 'none'; // Ensure dropdown is hidden
            teamBResultsDropdown.innerHTML = '';      // Clear dropdown content
            // Reset Team B input states
            teamBInternalInput.style.display = 'none';
            teamBSearchInput.style.display = 'none';
            teamBIdInput.value = ''; // Clear hidden ID
            // Remove listener for outside clicks
            document.removeEventListener('click', handleOutsideClick, true);
        }

        // *** MODIFIED Function: Update Team B input based on Match Type selection ***
        function updateTeamBInputType() {
            const selectedType = matchTypeSelect.value;
            teamBIdInput.value = ''; // Clear hidden ID whenever type changes
            teamBResultsDropdown.style.display = 'none'; // Hide dropdown

            if (selectedType === 'internal') {
                teamBInternalInput.style.display = 'block';
                teamBSearchInput.style.display = 'none';
                teamBInternalInput.value = teamANameInput.value; // Set to current team name
                teamBIdInput.value = teamAIdInput.value; // Store internal team B id
                teamBIdInput.required = true; // Still technically required
                teamBSearchInput.value = ''; // Clear search input
            } else if (selectedType === 'opponent') {
                teamBInternalInput.style.display = 'none';
                teamBSearchInput.style.display = 'block';
                teamBSearchInput.value = ''; // Clear search input on type change
                teamBIdInput.value = ''; // Clear ID, needs to be selected
                teamBIdInput.required = true; // The ID is required
            } else {
                // Default or placeholder state
                teamBInternalInput.style.display = 'none';
                teamBSearchInput.style.display = 'none';
                teamBSearchInput.value = '';
                teamBIdInput.value = '';
                teamBIdInput.required = false; // Not required if no type selected
            }
        }

        // *** NEW Function: Display search results in the dropdown ***
        function displaySearchResults(results) {
            teamBResultsDropdown.innerHTML = ''; // Clear previous results
            if (results.length === 0) {
                teamBResultsDropdown.innerHTML = '<div class="search-result-item no-results">Không tìm thấy đội nào</div>';
                teamBResultsDropdown.style.display = 'block';
                return;
            }

            results.forEach(team => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.textContent = team.teamName;
                item.dataset.id = team.id; // Store team ID
                item.dataset.name = team.teamName; // Store team name
                teamBResultsDropdown.appendChild(item);
            });

            teamBResultsDropdown.style.display = 'block';
        }

        // *** NEW Function: Handle clicks outside the search input/dropdown ***
        function handleOutsideClick(event) {
            if (!teamBWrapper.contains(event.target)) {
                teamBResultsDropdown.style.display = 'none';
            }
        }


        function openDialogForCreate() { /* ... modified slightly ... */
            if (!currentTeam) return;
            fixtureForm.reset();
            dialogTitle.textContent = 'Tạo trận đấu';
            fixtureIdInput.value = '';
            teamANameInput.value = currentTeam.teamName;
            teamAIdInput.value = currentTeam.id;
            matchTypeSelect.value = 'opponent'; // Default to opponent
            updateTeamBInputType(); // Setup correct Team B input
            showDialog();
        }

        function openDialogForEdit(fixtureId) { /* ... modified ... */
            const fixture = fixtures.find(f => f.id === fixtureId);
            if (!fixture || !currentTeam) return;
            fixtureForm.reset();
            dialogTitle.textContent = 'Sửa lịch thi đấu';
            fixtureIdInput.value = fixture.id;
            teamANameInput.value = currentTeam.teamName; // Assuming Team A is always the 'owner' team editing
            teamAIdInput.value = currentTeam.id;

            matchTypeSelect.value = fixture.matchType;
            scheduleDateTimeInput.value = fixture.scheduleDateTime || '';
            provinceSelect.value = fixture.province || '';
            districtSelect.value = fixture.district || '';
            venueInput.value = fixture.venue || '';

            updateTeamBInputType(); // Set up the correct input/select visibility first

            // Pre-fill Team B based on loaded data
            if (fixture.matchType === 'internal') {
                // teamBInternalInput should be filled by updateTeamBInputType
                teamBIdInput.value = fixture.teamBId; // Ensure hidden ID is set
            } else if (fixture.matchType === 'opponent') {
                const teamB = getTeamById(fixture.teamBId);
                if (teamB) {
                    teamBSearchInput.value = teamB.teamName; // Show the name in search input
                } else {
                    teamBSearchInput.value = ''; // Clear if team not found (data inconsistency)
                    console.warn(`Opponent team with ID ${fixture.teamBId} not found for fixture ${fixture.id}`);
                }
                teamBIdInput.value = fixture.teamBId || ''; // Set the hidden ID
            }
            showDialog();
        }


        function handleFormSubmit(event) { /* ... modified ... */
            event.preventDefault();

            const id = fixtureIdInput.value;
            const matchType = matchTypeSelect.value;
            const teamAId = teamAIdInput.value;
            const teamBId = teamBIdInput.value; // Get ID from the hidden input

            // *** Validation for Team B ***
            if (!matchType) {
                alert('Vui lòng chọn loại trận đấu.');
                return;
            }
            if (!teamBId) {
                if (matchType === 'opponent') {
                    alert('Vui lòng tìm và chọn đội đối thủ.');
                    teamBSearchInput.focus();
                } else {
                    // This case shouldn't happen if logic is correct for internal matches
                    alert('Lỗi: Không xác định được đội B.');
                }
                return;
            }
            // Basic check if the selected opponent name matches the hidden ID
            if (matchType === 'opponent') {
                const selectedOpponent = getTeamById(teamBId);
                if (!selectedOpponent || teamBSearchInput.value.trim() !== selectedOpponent.teamName) {
                    // If name doesn't match ID, or ID isn't found, force re-selection
                    alert('Đội đối thủ không hợp lệ. Vui lòng tìm và chọn lại từ danh sách.');
                    teamBIdInput.value = ''; // Clear invalid ID
                    teamBSearchInput.value = ''; // Clear input
                    teamBSearchInput.focus();
                    return;
                }
            }


            const fixtureData = {
                id: id || `fixture-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                matchType: matchType,
                teamAId: teamAId,
                teamBId: teamBId, // Use the value from the hidden input
                scheduleDateTime: scheduleDateTimeInput.value,
                province: provinceSelect.value,
                district: districtSelect.value,
                venue: venueInput.value.trim(),
                scoreA: null, // Or 0
                scoreB: null, // Or 0
                penaltyA: null,
                penaltyB: null,
            };

            if (id) {
                const index = fixtures.findIndex(f => f.id === id);
                if (index > -1) { fixtures[index] = fixtureData; }
                else { console.error("Fixture not found for editing:", id); alert("Lỗi: Không tìm thấy lịch thi đấu."); return; }
            } else {
                fixtures.push(fixtureData);
            }
            localStorage.setItem('fixtures', JSON.stringify(fixtures));
            closeDialog();
            renderFixtures();
        }

        function handleDeleteFixture(fixtureId) { /* ... keep existing ... */
            if (confirm('Bạn có chắc chắn muốn xóa lịch thi đấu này?')) {
                fixtures = fixtures.filter(f => f.id !== fixtureId);
                localStorage.setItem('fixtures', JSON.stringify(fixtures));
                renderFixtures();
            }
        }

        // --- Event Listeners ---

        createFixtureBtn.addEventListener('click', openDialogForCreate);
        closeDialogButtons.forEach(button => button.addEventListener('click', closeDialog));
        fixtureForm.addEventListener('submit', handleFormSubmit);
        matchTypeSelect.addEventListener('change', updateTeamBInputType);
        fixtureFilter.addEventListener('change', renderFixtures);
        fixtureListContainer.addEventListener('click', (event) => {
            const target = event.target;
            const editButton = target.closest('.edit-btn');
            const deleteButton = target.closest('.delete-btn');
            // const statsButton = target.closest('.stats-btn'); // No longer needed for navigation

            if (editButton && !editButton.disabled) { // Check if not disabled before acting
                openDialogForEdit(editButton.getAttribute('data-id'));
            } else if (deleteButton) {
                handleDeleteFixture(deleteButton.getAttribute('data-id'));
            }
             // Clicking .stats-btn (<a> tag) now navigates automatically
        });

        // *** NEW Event Listener for Team B Search Input ***
        teamBSearchInput.addEventListener('input', () => {
            const searchTerm = teamBSearchInput.value.trim().toLowerCase();
            teamBIdInput.value = ''; // Clear hidden ID when user types

            if (!searchTerm) {
                teamBResultsDropdown.style.display = 'none';
                return;
            }

            const filteredTeams = teams.filter(team =>
                team.id !== currentTeam.id && // Exclude current team
                team.teamName.toLowerCase().includes(searchTerm)
            );

            displaySearchResults(filteredTeams);
        });

        // *** NEW Event Listener for Selecting an item from Dropdown ***
        teamBResultsDropdown.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('search-result-item') && !target.classList.contains('no-results')) {
                const selectedId = target.dataset.id;
                const selectedName = target.dataset.name;

                teamBSearchInput.value = selectedName; // Set input display value
                teamBIdInput.value = selectedId;     // Set the hidden input's value (crucial!)
                teamBResultsDropdown.style.display = 'none'; // Hide dropdown
                teamBResultsDropdown.innerHTML = ''; // Clear dropdown
            }
        });

        // Prevent dropdown click from triggering the outside click handler immediately
        teamBResultsDropdown.addEventListener('click', (event) => {
            event.stopPropagation();
        });
        teamBSearchInput.addEventListener('click', (event) => {
            // If user clicks back into search input, maybe re-show dropdown if there's text?
            // Or just stop propagation to prevent immediate closing by outside click handler
            event.stopPropagation();
        });


        // --- Initialization ---
        function initialize() { /* ... keep existing ... */
            loadData();
            const teamIdFromUrl = getCurrentTeamIdFromUrl();
            if (teamIdFromUrl) {
                currentTeam = getTeamById(teamIdFromUrl);
                if (!currentTeam) {
                    console.error(`Team with ID "${teamIdFromUrl}" not found.`);
                    fixtureListContainer.innerHTML = `<p>Lỗi: Không tìm thấy đội với ID ${teamIdFromUrl}.</p>`;
                    createFixtureBtn.disabled = true; fixtureFilter.disabled = true;
                } else {
                    console.log("Current Team:", currentTeam);
                    renderFixtures();
                }
            } else {
                console.error("No team ID found in URL.");
                fixtureListContainer.innerHTML = "<p>Lỗi: Không có ID đội nào được chỉ định trong URL.</p>";
                createFixtureBtn.disabled = true; fixtureFilter.disabled = true;
            }
        }

        initialize();

    });
    </script>



</body>
</html>