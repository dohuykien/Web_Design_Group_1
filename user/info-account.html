<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trang thông tin tài khoản</title>
    <link rel="icon" type="logo.png" href="images/logo.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald&display=swap"
      rel="stylesheet"
    />
    <!-- Thêm font nếu cần -->
    <link
      href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Helvetica+Neue:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <!-- Giả lập Helvetica Neue -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link rel="stylesheet" href="/user/css/sidebar.css" />
    <link rel="stylesheet" href="/user/css/userheader.css" />
    <link rel="stylesheet" href="/user/css/userfooter.css" />

    <style>
      /* === PHẦN CSS GỐC CỦA BẠN - KHÔNG THAY ĐỔI === */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Oswald, sans-serif;
        text-decoration: none;
      }
      body {
        background-color: white;
      }

      /*----------------------Layout-------------------------*/
      .container {
        display: flex;
        width: 100%;
      }

      /*----------content: list-league + footer------------ */
      .content-wrapper {
        flex: 1;
        display: block;
        margin: 0;
        padding: 0;
      }
      .content {
        background-color: white;
        border-radius: 5px;
      }
      /* list-league */
      .list-league {
        color: rgb(34, 34, 34);
        font-size: 24px;
        font-weight: normal;
        padding: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }
      .list-league_left {
        font-family: "Source Sans Pro", sans-serif !important;
      }
      .list-league .fa-solid.fa-user {
        color: #ff6f00;
        margin-right: 8px;
        font-size: 22px;
      }
      .list-league_left {
        flex-grow: 1;
      }
      /*---------------------inputleague------------------*/
      .kienngu {
        background-color: #ecf0f5;
        padding-top: 10px;
        border-top: 1px solid #e4e2e2;
      }
      .box {
        display: flex;
        flex-wrap: wrap; /* Cho phép wrap */
        justify-content: space-between; /* Giữ space-between */
        /* Không có padding/margin gốc ở đây */
      }

      /*------------------- Box-left-------------------- */
      .box-left {
        /* Thêm selector cho box-left */
        /* Không có width gốc, sẽ dựa vào content hoặc set responsive */
        /* Cần thêm flex-basis hoặc width trong responsive */
        margin-bottom: 20px; /* Thêm khoảng cách dưới khi wrap */
      }

      .file-preview {
        width: 130%; /* Make the container full width */ /* Width gốc này hơi lạ, > 100%? */
        margin: 10px 10px 1px 18px; /* Space above the preview */
        padding: 5px;
        border: 1px solid #e4e2e2;
        border-radius: 3px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-sizing: border-box;
        background-color: #ffffff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .file-preview:empty {
        min-height: 36px; /* Explicitly set for empty kit preview */
      }
      .file-preview img {
        max-width: 100%; /* Image fits container width */
        max-height: 80px;
        display: block;
        border-radius: 8px;
        object-fit: contain; /* Maintain aspect ratio */
        border: none; /* Remove inner border if not needed */
      }
      .box-right {
        margin: 10px 15px 0 10px; /* margin gốc */
        padding: 30px 30px 5px 30px; /* padding gốc */
        background: #ffffff;
        border-radius: 3px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 80%; /* width gốc */
        /* Cần thêm flex-basis hoặc width trong responsive */
      }

      /* Nút tùy chỉnh */
      .custom-button {
        background-color: #5cb85c;
        color: white;
        margin-left: 18px; /* margin gốc */
        padding: 10px 0px 10px 15px; /* padding gốc */
        border-color: #4cae4c; /* border-color gốc */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* shadow gốc */
        cursor: pointer;
        font-size: 14px;
        width: 100%; /* width gốc */
        display: block; /* display gốc */
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; /* font gốc */
        /* Không có border-style, border-width */
      }

      .custom-button:hover {
        background-color: #4d9e51;
      }
      .fas.fa-upload {
        margin-right: 3px;
        font-size: 14px;
        position: relative;
        bottom: 3px;
      }
      .section {
        display: flex; /* display gốc */
        margin-bottom: 40px; /* margin gốc */
        border-bottom: 1px solid #ccc; /* border gốc */
        padding-bottom: 30px; /* padding gốc */
        flex-wrap: wrap; /* Cho phép wrap */
      }
      .section-left {
        width: 400px; /* width gốc */
        padding-right: 30px; /* padding gốc */
      }
      .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }
      .section-header i {
        color: #ff6f00;
        margin-right: 8px;
      }
      .section-header h2 {
        font-size: 20px;
        margin: 0;
        color: #333;
        font-weight: normal;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }
      .section-description {
        color: #888;
        font-size: 12px;
        margin-top: 15px;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }
      .section-right {
        flex: 1; /* flex gốc */
      }
      .form-group {
        /* align-items: center; */ /* Bỏ align-items nếu muốn label ở trên */
        margin-bottom: 15px; /* margin gốc */
        /* Không có display flex gốc */
      }
      .form-group label {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-weight: bold;
        font-size: 14px;
        /* Không có display block gốc */
      }
      .form-group input[type="text"],
      .form-group input[type="email"],
      .form-group input[type="password"] {
        flex: 1; /* flex gốc */
        padding: 8px; /* padding gốc */
        border: 1px solid #ccc;
        margin-top: 5px; /* margin gốc */
        box-shadow: rgba(0, 0, 0, 0.075) 0px 1px 1px 0px inset;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        width: 100%; /* width gốc */
      }
      .checkbox {
        display: flex;
        align-items: center;
        margin-top: 10px;
        padding-top: 20px;
        border-top: 1px solid #e8e5e5;
      }
      .checkbox input {
        margin-right: 7px;
        margin-bottom: 7px;
      }
      .changePassword {
        /* Class này để ẩn/hiện nhóm pass */
        /* Sẽ được JS set display: none/block */
      }

      .save-section {
        background: #f5f5f5;
        padding: 20px;
        text-align: right; /* align gốc */
        margin-bottom: 30px; /* margin gốc */
        /* Không có border-radius gốc */
      }
      .save-button {
        background-color: #00acec;
        color: white;
        padding: 5px 15px; /* padding gốc */
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25); /* border-color gốc */
        cursor: pointer;
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        font-size: 20px; /* font-size gốc */
        /* Không có border-style, border-width */
      }
      .save-button i {
        margin-right: 3px;
      }
      .save-button:hover {
        background-color: #0087b9;
      }
      /* === HẾT CSS GỐC === */

      /* === CSS RESPONSIVE (CHỈ THÊM PHẦN NÀY) === */
      @media (max-width: 992px) {
        /* Tablet ngang và nhỏ hơn */
        .box {
          padding: 0 10px; /* Thêm padding ngang cho box chính */
          margin: 0; /* Reset margin nếu cần */
        }
        .box-left {
          /* Đặt width cho box-left để tính toán */
          flex-basis: 200px; /* Hoặc một giá trị phù hợp */
          flex-shrink: 0; /* Không co lại */
          margin-right: 15px; /* Khoảng cách phải */
          width: auto; /* Bỏ width 100% nếu đã set flex-basis */
        }
        .box-right {
          width: auto; /* Bỏ width 80% */
          flex-basis: calc(
            100% - 215px
          ); /* Chiếm phần còn lại (trừ đi box-left và margin) */
          flex-grow: 1; /* Cho phép nó lớn ra */
          margin: 10px 0 0 0; /* Reset margin */
          padding: 20px; /* Giảm padding */
        }
        .file-preview {
          width: 100%; /* Cho preview chiếm hết box-left */
          margin: 10px 0 1px 0; /* Reset margin */
        }
        .custom-button {
          margin-left: 0; /* Reset margin */
          width: 100%; /* Button chiếm hết box-left */
          padding: 8px 15px; /* Chỉnh padding */
        }

        .section-left {
          width: 30%; /* Giảm width cột trái */
          padding-right: 15px; /* Giảm padding phải */
        }
        .section-right {
          /* Vẫn giữ flex: 1 */
        }
        .section-header h2 {
          font-size: 18px; /* Giảm cỡ chữ header section */
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"] {
          padding: 7px; /* Giảm padding input */
        }
        .save-button {
          font-size: 18px; /* Giảm cỡ chữ nút save */
          padding: 4px 12px;
        }
      }

      @media (max-width: 768px) {
        /* Tablet đứng và nhỏ hơn */
        .box {
          display: block; /* Cho box-left và box-right xếp chồng */
          padding: 0 10px; /* Giữ padding */
        }
        .box-left {
          flex-basis: auto; /* Reset flex-basis */
          width: 150px; /* Giới hạn chiều rộng avatar */
          margin: 0 auto 15px auto; /* Căn giữa và thêm margin dưới */
          margin-right: auto; /* Reset margin phải */
        }
        .box-right {
          flex-basis: auto; /* Reset flex-basis */
          width: 100%; /* Chiếm hết chiều rộng */
          padding: 15px; /* Giảm padding thêm */
        }
        .file-preview {
          /* Giữ nguyên style */
        }
        .custom-button {
          /* Giữ nguyên style */
        }

        .section {
          display: block; /* Cho section-left và section-right xếp chồng */
          padding-bottom: 20px; /* Giảm padding dưới */
          margin-bottom: 25px; /* Giảm margin dưới */
        }
        .section-left {
          width: 100%; /* Chiếm hết chiều rộng */
          padding-right: 0; /* Bỏ padding phải */
          margin-bottom: 15px; /* Thêm khoảng cách dưới */
          text-align: center; /* Căn giữa phần mô tả */
        }
        .section-header {
          justify-content: center; /* Căn giữa icon và header */
        }
        .section-right {
          /* Không cần style đặc biệt */
        }
        .form-group label {
          display: block; /* Label luôn ở trên */
          margin-bottom: 5px; /* Khoảng cách dưới label */
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"] {
          /* Đã là width 100% */
        }
        .save-section {
          text-align: center; /* Căn giữa nút save */
          padding: 15px;
        }
        .save-button {
          font-size: 16px;
        }
      }

      @media (max-width: 480px) {
        /* Điện thoại nhỏ */
        .content {
          margin: 5px;
        } /* Giảm margin content */
        .list-league {
          padding: 10px;
          font-size: 20px;
        }
        .list-league .fa-solid.fa-user {
          font-size: 20px;
        }

        .box {
          padding: 0 5px;
        }
        .box-left {
          width: 120px;
        } /* Thu nhỏ avatar thêm */
        .box-right {
          padding: 10px;
        }

        .section-header h2 {
          font-size: 17px;
        }
        .section-description {
          font-size: 11px;
        }
        .form-group label {
          font-size: 13px;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"] {
          font-size: 14px;
          padding: 8px;
        }

        .save-button {
          font-size: 15px;
          padding: 5px 10px;
        }
        .custom-button {
          padding: 7px 10px;
          font-size: 13px;
        }
      }
      /* === HẾT CSS RESPONSIVE === */
    </style>
  </head>
  <body>
    <header id="header-container" class="header"></header>

    <div class="container">
      <div id="sidebar-container"></div>
      <div class="content-wrapper">
        <section class="content">
          <div class="list-league">
            <span class="list-league_left"
              ><i class="fa-solid fa-user"></i>Thông tin tài khoản</span
            >
          </div>

          <div class="kienngu">
            <div class="box">
              <div class="box-left">
                <div id="logoPreview" class="file-preview">
                  <img src="dangoai" alt="avatar" />
                  <!-- Giữ nguyên ảnh gốc -->
                </div>
                <div>
                  <label for="logoFile" class="custom-button">
                    <i class="fas fa-upload"></i> Chọn ảnh...
                  </label>
                </div>
                <input
                  type="file"
                  id="logoFile"
                  name="imageFile"
                  accept="image/*"
                  style="display: none"
                />
              </div>
              <div class="box-right">
                <div class="section">
                  <div class="section-left">
                    <div class="section-header">
                      <i class="fa-brands fa-github"></i>
                      <h2>Thông tin tài khoản</h2>
                    </div>
                    <div class="section-description">
                      Thông tin tài khoản của bạn
                    </div>
                  </div>
                  <div class="section-right">
                    <div class="form-group">
                      <label for="usernameInput">Username</label> <!-- Added for attribute -->
                      <input
                        id="usernameInput"
                        type="text"
                        placeholder="Username"
                      />
                    </div>
                    <div class="form-group">
                      <label for="emailInput">E-mail</label> <!-- Added for attribute -->
                      <input
                        id="emailInput"
                        type="email"
                        placeholder="E-mail"
                        readonly 
                      />
                    </div>
                    <div class="checkbox">
                      <input type="checkbox" id="changePasswordCheckbox" /> <!-- Changed ID -->
                      <label for="changePasswordCheckbox">Đổi mật khẩu?</label> <!-- Changed ID -->
                    </div>
                    <div class="changePassword"> <!-- This div is controlled by JS -->
                      <div class="form-group">
                        <label for="newPasswordInput">Mật khẩu mới</label> <!-- Added ID -->
                        <input type="password" id="newPasswordInput" placeholder="Mật khẩu mới" /> <!-- Changed type to password -->
                      </div>
                      <div class="form-group">
                        <label for="confirmPasswordInput">Xác nhận mật khẩu</label> <!-- Added ID -->
                        <input
                          type="password" id="confirmPasswordInput"
                          placeholder="Xác nhận mật khẩu"
                        /> <!-- Changed type to password -->
                      </div>
                    </div>
                  </div>
                </div>

                <div class="section">
                  <div class="section-left">
                    <div class="section-header">
                      <i class="fa fa-user"></i>
                      <h2>Thông tin cá nhân</h2>
                    </div>
                    <div class="section-description">
                      Thông tin cá nhân của bạn
                    </div>
                  </div>
                  <div class="section-right">
                    <div class="form-group">
                      <label for="firstNameInput">First name</label> <!-- Added for -->
                      <input id="firstNameInput" type="text" placeholder="First name" /> <!-- Removed default value -->
                    </div>
                    <div class="form-group">
                      <label for="lastNameInput">Last name</label> <!-- Added for -->
                      <input id="lastNameInput" type="text" placeholder="Last name" /> <!-- Removed default value -->
                    </div>
                    <div class="form-group">
                      <label for="phoneInput">Điện thoại</label> <!-- Added for -->
                      <input id="phoneInput" type="text" placeholder="Phone" />
                    </div>
                    <div class="form-group">
                      <label for="addressInput">Địa chỉ</label> <!-- Added for -->
                      <input
                        id="addressInput"
                        type="text"
                        placeholder="Address"
                      />
                    </div>
                  </div>
                </div>

                <div class="save-section">
                  <!-- Changed button type to submit, will prevent default in JS -->
                  <button type="submit" class="save-button">
                    <i class="fa fa-save"></i> Lưu
                  </button>
                </div>
              </div>
            </div>

            <footer id="footer" class="footer"></footer>
          </div>
        </section>
      </div>
    </div>

    <!-- JavaScript giữ nguyên -->
    <script src="/user/js/sidebar.js"></script>
    <script src="/user/js/userheader.js"></script>
    <script src="/user/js/componentloader.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
          // --- DOM Element References ---
          const profileForm = document.getElementById("profileForm");
          const logoFileInput = document.getElementById("logoFile");
          const logoPreview = document.getElementById("logoPreview");
          const usernameInput = document.getElementById("usernameInput");
          const emailInput = document.getElementById("emailInput");
          const firstNameInput = document.getElementById("firstNameInput");
          const lastNameInput = document.getElementById("lastNameInput");
          const phoneInput = document.getElementById("phoneInput");
          const addressInput = document.getElementById("addressInput");
          const changePasswordCheckbox = document.getElementById("changePasswordCheckbox");
          const changePasswordContainer = document.querySelector(".changePassword");
          const newPasswordInput = document.getElementById("newPasswordInput");
          const confirmPasswordInput = document.getElementById("confirmPasswordInput");
          const saveButton = document.querySelector(".save-button");
  
           // --- localStorage Helper Functions --- (Copied/adapted from script.js)
          function getUsers() {
              const usersJson = localStorage.getItem('users');
              try {
                  return usersJson ? JSON.parse(usersJson) : [];
              } catch (e) {
                  console.error("Error parsing users JSON from localStorage", e);
                  return [];
              }
          }
  
          function saveUsers(usersArray) {
              try {
                  localStorage.setItem('users', JSON.stringify(usersArray));
              } catch (e) {
                   console.error("Error saving users JSON to localStorage", e);
                   alert("Lỗi khi lưu dữ liệu người dùng!");
              }
          }
  
          // --- Avatar Placeholder ---
           const defaultAvatarPlaceholderHTML = '<span class="avatar-placeholder">avatar</span>'; // Placeholder text/HTML
  
          // --- Load Initial Profile Data ---
          function loadProfileData() {
              const userId = localStorage.getItem("userProfile_id");
              if (!userId) {
                  alert("Bạn cần đăng nhập để xem trang này.");
                  // Optionally redirect to login page
                  // window.location.href = '/login.html'; // Adjust path if needed
                  profileForm.style.display = 'none'; // Hide form if not logged in
                  return;
              }
  
              const loadValue = (element, storageKey) => {
                  if (element) {
                      const savedValue = localStorage.getItem(storageKey);
                      // Only set value if it exists, otherwise leave placeholder
                      if (savedValue !== null && savedValue !== 'null' && savedValue !== 'undefined') {
                           element.value = savedValue;
                      }
                  } else {
                      console.warn(`Element for key ${storageKey} not found during load.`);
                  }
              };
  
              loadValue(usernameInput, "userProfile_username");
              loadValue(emailInput, "userProfile_email");
              loadValue(firstNameInput, "userProfile_firstname");
              loadValue(lastNameInput, "userProfile_lastname");
              loadValue(phoneInput, "userProfile_phone");
              loadValue(addressInput, "userProfile_address");
  
              // Load Avatar
              const savedAvatar = localStorage.getItem("userProfile_avatar");
               logoPreview.innerHTML = ''; // Clear previous content
  
               if (savedAvatar && savedAvatar.startsWith("data:image")) {
                   const img = document.createElement("img");
                   img.src = savedAvatar;
                   img.alt = "Avatar";
                   img.onerror = () => { // Handle potential load error for saved base64
                      logoPreview.innerHTML = defaultAvatarPlaceholderHTML;
                   };
                   logoPreview.appendChild(img);
               } else {
                   // Display placeholder if no valid avatar is stored
                   logoPreview.innerHTML = defaultAvatarPlaceholderHTML;
               }
  
              // Initial state for password fields
              changePasswordContainer.style.display = "none";
              changePasswordCheckbox.checked = false;
              newPasswordInput.value = '';
              confirmPasswordInput.value = '';
          }
  
          // --- Avatar Preview Handler ---
          logoFileInput.addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (!file || !file.type.startsWith('image/')) {
                // Optionally alert user about invalid file type
                return;
            }
  
            const reader = new FileReader();
            reader.onload = function (event) {
              const img = document.createElement("img");
              img.src = event.target.result; // This will be the Base64 string
              img.alt = "Xem trước Avatar";
              logoPreview.innerHTML = ""; // Clear existing preview/placeholder
              logoPreview.appendChild(img);
            };
             reader.onerror = function() {
                 console.error("Error reading file for preview.");
                 alert("Không thể đọc tệp ảnh đã chọn.");
                 logoPreview.innerHTML = defaultAvatarPlaceholderHTML; // Reset on error
             }
            reader.readAsDataURL(file);
          });
  
        // --- Change Password Checkbox Handler ---
        changePasswordCheckbox.addEventListener("change", function () {
            changePasswordContainer.style.display = this.checked ? "block" : "none";
            if (!this.checked) {
                // Clear password fields if checkbox is unchecked
                newPasswordInput.value = "";
                confirmPasswordInput.value = "";
            }
          });
  
        // --- Save Profile Handler ---
        profileForm.addEventListener("submit", function (event) {
            event.preventDefault(); // Prevent actual form submission
  
            const userId = localStorage.getItem("userProfile_id");
            if (!userId) {
                alert("Lỗi: Không tìm thấy ID người dùng. Vui lòng đăng nhập lại.");
                return;
            }
            const userIdInt = parseInt(userId, 10);
  
            // --- Get Current Form Values ---
            const newUsername = usernameInput.value.trim();
            const newFirstName = firstNameInput.value.trim();
            const newLastName = lastNameInput.value.trim();
            const newPhone = phoneInput.value.trim();
            const newAddress = addressInput.value.trim();
  
            // --- Password Update Validation (if checkbox is checked) ---
            let newPassword = null; // Store the new password if valid
            if (changePasswordCheckbox.checked) {
                const pass1 = newPasswordInput.value;
                const pass2 = confirmPasswordInput.value;
                if (!pass1 || !pass2) {
                    alert("Vui lòng nhập cả mật khẩu mới và xác nhận mật khẩu.");
                    return;
                }
                if (pass1 !== pass2) {
                    alert("Mật khẩu mới và xác nhận mật khẩu không khớp.");
                    return;
                }
                // Basic password length check (optional)
                if (pass1.length < 6) {
                     alert("Mật khẩu phải có ít nhất 6 ký tự.");
                     return;
                }
                newPassword = pass1; // Assign the validated password
                // !!! SECURITY WARNING: Storing plain text password! Only for demo.
            }
  
            // --- Avatar Update ---
            let newAvatarData = localStorage.getItem('userProfile_avatar') || null; // Start with existing or null
            const previewImage = logoPreview.querySelector("img");
            if (previewImage && previewImage.src && previewImage.src.startsWith("data:image")) {
                // Only update if there's a *new* Base64 image in the preview
                newAvatarData = previewImage.src;
            } else if (previewImage && previewImage.src && !previewImage.src.startsWith("data:image")) {
                // If the preview src is not base64 (e.g., an old URL), keep the stored one
                console.log("Preview image is not a new Base64 upload, keeping stored avatar.");
            } else if (!previewImage || (previewImage && !previewImage.src)) {
                // If the preview is empty or has no src, clear avatar
                newAvatarData = null;
            }
  
            // --- Update localStorage `userProfile_*` Keys ---
            try {
                localStorage.setItem("userProfile_username", newUsername);
                localStorage.setItem("userProfile_firstname", newFirstName);
                localStorage.setItem("userProfile_lastname", newLastName);
                localStorage.setItem("userProfile_phone", newPhone);
                localStorage.setItem("userProfile_address", newAddress);
                // Only update password if a new one was provided and validated
                if (newPassword !== null) {
                    localStorage.setItem("userProfile_password", newPassword);
                }
                // Update avatar - store null if no valid avatar
                if (newAvatarData) {
                   localStorage.setItem("userProfile_avatar", newAvatarData);
                } else {
                   localStorage.removeItem("userProfile_avatar"); // Remove if null/empty
                }
  
                // --- Update the `users` Array in localStorage ---
                let users = getUsers();
                const userIndex = users.findIndex(u => u.id === userIdInt);
  
                if (userIndex > -1) {
                    users[userIndex].username = newUsername;
                    users[userIndex].firstname = newFirstName;
                    users[userIndex].lastname = newLastName;
                    users[userIndex].phone = newPhone;
                    users[userIndex].address = newAddress;
                    users[userIndex].avatar = newAvatarData; // Save Base64 or null
                    // Only update password in array if new one was provided
                    if (newPassword !== null) {
                        users[userIndex].password = newPassword; // Insecure!
                    }
                    saveUsers(users); // Save the updated array
                    console.log(`User data in 'users' array updated for ID: ${userIdInt}`);
                } else {
                    console.error(`User with ID ${userIdInt} not found in users array.`);
                    alert("Lỗi: Không tìm thấy thông tin người dùng gốc để cập nhật.");
                    return; // Stop if user couldn't be found in the main array
                }
  
                // --- [REMOVED] Header UI Update Section ---
  
                // --- Success Feedback ---
                alert("Đã lưu thông tin thành công!");
                // Reset password fields after successful save if they were changed
                if (changePasswordCheckbox.checked) {
                    newPasswordInput.value = "";
                    confirmPasswordInput.value = "";
                    changePasswordCheckbox.checked = false;
                    changePasswordContainer.style.display = "none";
                }
  
  
            } catch (e) {
                console.error("Lỗi khi lưu thông tin vào localStorage:", e);
                alert("Đã xảy ra lỗi khi lưu thông tin. Vui lòng thử lại.");
            }
          });
  
        // --- Initial Load ---
          loadProfileData(); // Load data when the page loads
  
         // --- [REMOVED] attemptHeaderUpdateOnLoad function and related calls ---
  
        }); // End DOMContentLoaded
      </script>
  </body>
</html>
