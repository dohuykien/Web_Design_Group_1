<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trang tạo mùa giải</title>
    <link rel="icon" type="logo.png" href="images/logo.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link rel="stylesheet" href="/user/css/sidebar.css" />
    <link rel="stylesheet" href="/user/css/userheader.css" />
    <link rel="stylesheet" href="/user/css/userfooter.css" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Oswald, sans-serif;
        text-decoration: none;
      }
      body {
        background-color: white;
      }

      /*----------------------Layout-------------------------*/
      .container {
        display: flex;
        width: 100%;
      }

      /*----------content: list-league + footer------------ */
      .content-wrapper {
        flex: 1;
        display: block;
        margin: 0;
        padding: 0;
      }
      .content {
        background-color: white;
        border-radius: 5px;
      }
      /* list-league */
      .list-league {
        color: rgb(34, 34, 34);
        font-size: 24px;
        font-weight: normal;
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }
      .list-league_left {
        font-family: "Source Sans Pro", sans-serif !important;
      }
      .fa-solid.fa-check {
        color: #ff6f00;
        margin-right: 8px;
        font-size: 25px;
      }
      .list-league_left {
        flex-grow: 1;
      }

      .save {
        color: rgb(255, 255, 255);
        padding: 7px 12px 6px 12px;
        background-color: #49bf67;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
        border-style: solid;
        border-width: 0.8px;
        cursor: pointer;
        text-shadow: rgba(0, 0, 0, 0.25) 0px -1px 0px;
        box-shadow: 0px -1px 5px rgba(0, 0, 0, 0.1);
      }
      .save:hover {
        background-color: #379e51;
      }
      .fa-solid.fa-rotate {
        margin-right: 3px;
        font-size: 15px;
      }
      .fa-regular.fa-floppy-disk {
        margin-right: 3px;
        font-size: 15px;
      }
      .Nhaplai {
        color: rgb(255, 255, 255);
        padding: 7px 12px 6px 12px;
        background-color: rgb(0, 172, 236);
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
        border-style: solid;
        border-width: 0.8px;
        cursor: pointer;
        text-shadow: rgba(0, 0, 0, 0.25) 0px -1px 0px;
        box-shadow: 0px -1px 5px rgba(0, 0, 0, 0.1);
      }
      .Nhaplai:hover {
        background-color: #428bca;
      }
      .return {
        color: rgb(255, 255, 255);
        padding: 7px 12px 6px 12px;
        background-color: #f34541;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
        border-style: solid;
        border-width: 0.8px;
        cursor: pointer;
        text-shadow: rgba(0, 0, 0, 0.25) 0px -1px 0px;
        box-shadow: 0px -1px 5px rgba(0, 0, 0, 0.1);
      }
      .return:hover {
        background-color: #dd1b18;
      }

      /*---------------------inputseason------------------*/
      .kienngu {
        background-color: #ecf0f5;
        padding-top: 10px;
        border-top: 1px solid #e4e2e2;
      }
      .box {
        display: flex;
      }
      .success {
        max-width: 1250px;
        margin: 10px 30px 5px 30px;
        padding: 7px 15px 7px 15px;
        color: rgb(1, 167, 1);
        font-size: 14px;
        background-color: rgb(221, 253, 221);
        border: 1px solid #e4e2e2;
        display: none;
      }
      .box-left {
        max-width: 1250px;
        margin: 12px 15px 0 30px;
        padding: 0 20px 5px 20px;
        background: #ffffff;
        border: 1px solid #e4e2e2;
        border-radius: 3px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        flex: 2;
      }
      .nguyenkhi {
        max-width: 1250px;
        margin: 20px 15px 0 30px;
        padding: 5px 10px;
        background: #ccc;
        color: #fff;
        border: 1px solid #e4e2e2;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 14px;
        flex: 2;
      }
      .chiabang {
        max-width: 1250px;
        margin: -1px 15px 0 30px;
        padding: 0 20px 5px 20px;
        background: #ffffff;
        border: 1px solid #e4e2e2;
        border-radius: 3px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        flex: 2;
        transition: opacity 0.3s ease;
      }
      .box-right {
        max-width: 1000px;
        margin: 12px 30px 0 15px;
        padding: 5px 15px 30px 15px;
        background: #ffffff;
        border: 1px solid #e4e2e2;
        border-radius: 3px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        flex: 1;
        max-height: fit-content;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 0;
      }
      .col {
        flex: 1;
        padding: 10px;
        min-width: 230px;
      }
      .box-left label {
        font-size: 14px;
        display: block;
        margin-bottom: 5px;
      }
      input,
      select {
        width: 100%;
        padding: 8px 6px;
        margin-top: 5px;
        border: 1px solid #ccc;
        box-shadow: rgba(0, 0, 0, 0.075) 0px 1px 1px 0px inset;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }
      input:focus {
        outline: 0;
        border-color: #969696;
      }
      .toggle {
        width: 60px;
        height: 20px;
        background-color: rgb(240, 22, 17);
        border-radius: 100rem;
        transition: all 0.1s linear;
      }
      .spinner {
        border-radius: 100rem;
        width: 20px;
        height: 20px;
        background-color: white;
        transition: all 0.1s linear;
      }
      .toggle-label input {
        display: none;
      }
      toggle-label {
        cursor: pointer;
        display: inline-block;
      }
      .toggle-label input:checked + .toggle {
        background-color: #49bf67;
      }
      .toggle-label input:checked + .toggle .spinner {
        transform: translateX(40px);
      }
      /*-----------------General File Upload Label-------------------*/
      .file-upload-label {
        display: inline-block; /* Default */
        padding: 8px 15px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
        font-size: 15px;
        text-align: center;
        border: 1px solid transparent;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }
      .file-upload-label i {
        margin-right: 5px;
      }
      .file-upload-label:hover {
        background-color: #0056b3; /* Darker hover */
      }
      .file-upload-label.file-upload {
        display: block; /* Make it block level */
        width: 100%; /* Make it full width */
        box-sizing: border-box; /* Include padding in width */
        margin-top: 5px; /* Add space below the main label */
        background-color: #49bf67; /* Info color */
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
        box-shadow: 0px -1px 5px rgba(0, 0, 0, 0.1);
      }
      .file-upload-label.file-upload:hover {
        background-color: #4d9e51;
      }
      /* Specific Kit Preview Area - NOW FULL WIDTH */
      .file-preview {
        width: 100%;
        margin-top: 15px;
        border: 1px dashed #ccc;
        border-radius: 6px;
        min-height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 8px;
        box-sizing: border-box;
        background-color: #fff;
      }
      .file-preview:empty {
        min-height: 100px;
      }
      .file-preview img {
        max-width: 100%;
        max-height: 80px;
        display: block;
        border-radius: 8px;
        object-fit: contain;
        border: none;
      }

      .location,
      .fanpage {
        margin-top: 10px;
      }
      .location input,
      .fanpage input {
        margin-top: 8px;
      }
      /* ------------------inputseason-end-----------------*/
    </style>
  </head>
  <body>
    <header id="header-container" class="header">
      <!-- Header will be loaded here -->
    </header>

    <div class="container">
      <div id="sidebar-container">
        <!-- Sidebar will be loaded here -->
      </div>
      <div class="content-wrapper">
        <section class="content">
          <div class="list-league">
            <span class="list-league_left"
              ><i class="fa-solid fa-check"></i>Thêm mùa giải</span
            >

            <div class="wrap">
              <a href="#">
                <button class="save">
                  <i class="fa-regular fa-floppy-disk"></i> Lưu
                </button>
              </a>
              <a href="addseason.html">
                <button class="Nhaplai">
                  <i class="fa-solid fa-rotate"></i> Nhập lại
                </button>
              </a>
              <a href="danhsachmuagiai.html">
                <button class="return">
                  <i class="fa-solid fa-arrow-left"></i> Danh sách mùa giải
                </button>
              </a>
            </div>
          </div>

          <div class="kienngu">
            <div class="success">Thêm thành công</div>
            <div class="box">
              <div>
                <div class="box-left">
                  <div class="row">
                    <div class="col">
                      <label>Tên mùa giải</label>
                      <input type="text" id="tenMuaGiai" />
                    </div>
                  </div>

                  <div class="row">
                    <div class="col">
                      <label>Thời gian bắt đầu</label>
                      <input
                        type="text"
                        id="thoiGianBatDau"
                        placeholder="Thời gian bắt đầu"
                        onfocus="(this.type='date')"
                        onblur="if(!this.value) this.type='text'"
                        style="background-color: #eeeeee"
                      />
                    </div>
                    <div class="col">
                      <label>Thời gian kết thúc</label>
                      <input
                        type="text"
                        id="thoiGianKetThuc"
                        placeholder="Thời gian kết thúc"
                        onfocus="(this.type='date')"
                        onblur="if(!this.value) this.type='text'"
                        style="background-color: #eeeeee"
                      />
                    </div>
                  </div>

                  <div class="row">
                    <div class="col">
                      <label>Số đội tham dự</label>
                      <input type="number" id="soDoiThamDu" />
                    </div>
                  </div>

                  <div class="row">
                    <div class="col">
                      <label>Thể thức thi đấu</label>
                      <select id="matchFormat">
                        <option value="round_robin">Vòng tròn</option>
                        <option value="group_knockout">Chia bảng</option>
                      </select>
                    </div>
                    <div class="col">
                      <label>Số lượt đá vòng tròn</label>
                      <select id="roundRobinTurns">
                        <option value="1">1 lượt</option>
                        <option value="2">2 lượt</option>
                        <option value="3">3 lượt</option>
                        <option value="4">4 lượt</option>
                        <option value="5">5 lượt</option>
                      </select>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col">
                      <label>Điểm thắng</label>
                      <input id="pointsWin" type="number" value="3" />
                    </div>
                    <div class="col">
                      <label>Điểm hòa</label>
                      <input id="pointsDraw" type="number" value="1" />
                    </div>
                    <div class="col">
                      <label>Điểm thua</label>
                      <input id="pointsLoss" type="number" value="0" />
                    </div>
                  </div>

                  <div class="row" id="bronzeMatchSection">
                    <div class="col">
                      <label
                        for="hasBronzeMatchToggle"
                        class="toggle-label"
                        style="display: flex"
                        >Tranh giải ba
                        <input
                          id="hasBronzeMatchToggle"
                          type="checkbox"
                          name=""
                        />
                        <div class="toggle" style="margin-left: 20px">
                          <div class="spinner"></div>
                        </div>
                      </label>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col">
                      <label>Số cầu thủ 1 đội</label>
                      <input id="maxPlayers" type="number" />
                    </div>
                    <div class="col">
                      <label>Số thành viên ban huấn luyện</label>
                      <input id="maxStaff" type="number" />
                    </div>
                  </div>

                  <div class="row">
                    <div class="col">
                      <label>Số hiệp - set 1 trận</label>
                      <input id="numberOfHalves" type="number" />
                    </div>
                    <div class="col">
                      <label>Thời gian 1 hiệp - set (phút)</label>
                      <input id="halfTimeDuration" type="number" />
                    </div>
                  </div>
                </div>
                <div class="nguyenkhi" id="groupKnockoutTitleSection">
                  CẤU HÌNH BẢNG ĐẤU VÀ VÒNG KNOCKOUT
                </div>
                <div class="chiabang" id="groupKnockoutFieldsSection">
                  <div class="row">
                    <div class="col">
                      <label for="groupCount">Tổng số bảng</label>
                    </div>
                    <div class="col">
                      <input id="groupCount" type="number" value="1" min="0" />
                    </div>
                  </div>

                  <div class="row">
                    <div class="col">
                      <label for="teamsFromGroup1st">Số đội nhất bảng</label>

                      <input
                        id="teamsFromGroup1st"
                        type="number"
                        value="0"
                        min="0"
                      />
                    </div>
                    <div class="col">
                      <label for="teamsFromGroup2nd">Số đội nhì bảng</label>
                      <input
                        id="teamsFromGroup2nd"
                        type="number"
                        value="0"
                        min="0"
                      />
                    </div>
                  </div>
                  <div class="row">
                    <div class="col">
                      <label for="teamsFromGroup3rd">Số đội thứ ba bảng</label>

                      <input
                        id="teamsFromGroup3rd"
                        type="number"
                        value="0"
                        min="0"
                      />
                    </div>
                    <div class="col">
                      <label for="teamsFromGroup4th">Số đội thứ tư bảng</label>

                      <input
                        id="teamsFromGroup4th"
                        type="number"
                        value="0"
                        min="0"
                      />
                    </div>
                  </div>
                </div>
              </div>
              <!-- end box-left-->

              <!-- box-right -->
              <div class="box-right">
                <div>
                  <label>Logo</label>
                  <label for="logoFile" class="file-upload-label file-upload">
                    <i class="fas fa-upload"></i> Chọn ảnh...
                  </label>
                  <input
                    type="file"
                    id="logoFile"
                    name="imageFile"
                    accept="image/*"
                    style="display: none"
                  />
                  <div id="logoPreview" class="file-preview"></div>
                  <!-- Preview area -->
                </div>

                <div>
                  <label>Hình nền</label>
                  <label for="wpFile" class="file-upload-label file-upload">
                    <i class="fas fa-upload"></i> Chọn ảnh...
                  </label>
                  <input
                    type="file"
                    id="wpFile"
                    name="imageFile"
                    accept="image/*"
                    style="display: none"
                  />
                  <div id="wpPreview" class="file-preview"></div>
                  <!-- Preview area -->
                </div>
                <div class="location">
                  <label for="location">Địa điểm thi đấu</label>
                  <input type="text" id="location" placeholder="Nhập vị trí" />
                </div>
                <div class="fanpage">
                  <label for="fanpage">Fanpage giải đấu</label>
                  <input type="text" id="fanpage" />
                </div>
              </div>
            </div>
            <footer id="footer" class="footer"></footer>
          </div>
        </section>
      </div>
    </div>

    <script src="/user/js/sidebar.js"></script>
    <script src="/user/js/userheader.js"></script>
    <script src="/user/js/componentloader.js"></script>

    <script>
      // ----- ***** ĐỌC LEAGUE ID TỪ URL ***** -----
      let currentLeagueId = null;
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const leagueIdFromUrl = urlParams.get("leagueId");
        if (leagueIdFromUrl) {
          currentLeagueId = parseInt(leagueIdFromUrl, 10);
          if (isNaN(currentLeagueId)) {
            throw new Error("League ID không hợp lệ.");
          }
          console.log(
            `DEBUG (addseason): Received leagueId: ${currentLeagueId}`
          );
          // Cập nhật link quay lại (Nếu nút có trong file này)
          const backToListLink = document
            .querySelector(".return")
            ?.closest("a");
          if (backToListLink) {
            // **QUAN TRỌNG**: Đảm bảo link này trỏ đúng về trang danh sách mùa giải kèm leagueId
            backToListLink.href = `danhsachmuagiai.html?leagueId=${currentLeagueId}`;
          }
        } else {
          console.error(
            "DEBUG (addseason): CRITICAL - No leagueId found in URL!"
          );
          alert(
            "Lỗi: Không xác định được giải đấu để tạo mùa giải! Hãy quay lại trang danh sách giải đấu."
          );
          const saveButtonForDisable = document.querySelector(".save");
          if (saveButtonForDisable) {
            saveButtonForDisable.disabled = true;
            saveButtonForDisable.style.opacity = 0.6;
            saveButtonForDisable.style.cursor = "not-allowed";
          }
        }
      } catch (e) {
        console.error("DEBUG (addseason): Error processing leagueId:", e);
        alert("Lỗi đọc ID giải đấu từ URL hoặc ID không hợp lệ!");
        const saveButtonForDisable = document.querySelector(".save");
        if (saveButtonForDisable) {
          saveButtonForDisable.disabled = true;
          saveButtonForDisable.style.opacity = 0.6;
          saveButtonForDisable.style.cursor = "not-allowed";
        }
      }
      // ----- KẾT THÚC ĐỌC LEAGUE ID -----

      // Biến lưu Data URL ảnh
      let logoDataUrl = null;
      let wpDataUrl = null;

      // --- DOM Elements ---
      const logoFileInput = document.getElementById("logoFile");
      const logoPreview = document.getElementById("logoPreview");
      const wallpaperFileInput = document.getElementById("wpFile");
      const wallpaperPreview = document.getElementById("wpPreview");
      // **** SỬA CÁCH LẤY ELEMENT Ở ĐÂY ****
      const formatSelect = document.getElementById("matchFormat"); // Dùng ID
      const thirdPlaceRow = document.getElementById("bronzeMatchSection"); // Dùng ID
      const groupConfigHeader = document.getElementById(
        "groupKnockoutTitleSection"
      ); // Dùng ID
      const groupConfigSection = document.getElementById(
        "groupKnockoutFieldsSection"
      ); // Dùng ID
      // **********************************
      const saveBtn = document.querySelector(".save");
      const successMsg = document.querySelector(".success");
      const tenMuaGiaiInput = document.getElementById("tenMuaGiai");
      const soDoiThamDuInput = document.getElementById("soDoiThamDu");
      // Lấy các element input khác bằng ID tương ứng
      const thoiGianBatDauInput = document.getElementById("thoiGianBatDau");
      const thoiGianKetThucInput = document.getElementById("thoiGianKetThuc");
      const roundRobinTurnsSelect = document.getElementById("roundRobinTurns");
      const pointsWinInput = document.getElementById("pointsWin");
      const pointsDrawInput = document.getElementById("pointsDraw");
      const pointsLossInput = document.getElementById("pointsLoss");
      const hasBronzeMatchToggle = document.getElementById(
        "hasBronzeMatchToggle"
      );
      const maxPlayersInput = document.getElementById("maxPlayers");
      const maxStaffInput = document.getElementById("maxStaff");
      const numberOfHalvesInput = document.getElementById("numberOfHalves");
      const halfTimeDurationInput = document.getElementById("halfTimeDuration");
      const groupCountInput = document.getElementById("groupCount");
      const teamsFromGroup1stInput =
        document.getElementById("teamsFromGroup1st");
      const teamsFromGroup2ndInput =
        document.getElementById("teamsFromGroup2nd");
      const teamsFromGroup3rdInput =
        document.getElementById("teamsFromGroup3rd");
      const teamsFromGroup4thInput =
        document.getElementById("teamsFromGroup4th");
      const locationInput = document.getElementById("location");
      const fanpageInput = document.getElementById("fanpage");

      // --- Hàm Preview ảnh và Lưu Data URL ---
      function previewImage(inputElement, previewElement, setDataUrlCallback) {
        if (!inputElement || !previewElement) {
          console.error(`DEBUG (addseason): Missing elements for preview.`);
          return;
        }
        inputElement.addEventListener("change", function () {
          previewElement.innerHTML = "";
          const file = this.files[0];
          setDataUrlCallback(null);

          const renderPreview = (src) => {
            const isLogo = inputElement.id === "logoFile";
            const imgStyle = isLogo
              ? "max-width: 100%; max-height: 80px; display: block; border-radius: 3px; object-fit: contain;"
              : "max-width: 100%; max-height: 150px; display: block; border-radius: 3px; object-fit: cover;";
            if (src) {
              previewElement.innerHTML = `<img src="${src}" alt="Preview" style="${imgStyle}">`;
            } else {
              previewElement.innerHTML = "";
            }
          };

          if (file && file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = (e) => {
              renderPreview(e.target.result);
              setDataUrlCallback(e.target.result);
            };
            reader.onerror = (e) => {
              console.error(`DEBUG (addseason): FileReader error:`, e);
            };
            reader.readAsDataURL(file);
          } else {
            if (file) {
              alert("Vui lòng chọn file ảnh hợp lệ.");
              inputElement.value = null;
            }
            renderPreview(null); // Clear preview if no valid file
          }
        });
      }
      previewImage(logoFileInput, logoPreview, (url) => (logoDataUrl = url));
      previewImage(
        wallpaperFileInput,
        wallpaperPreview,
        (url) => (wpDataUrl = url)
      );

      // --- Hàm ẩn/hiện dựa trên thể thức (Dùng ID và VALUE) ---
      function updateUIBasedOnFormat() {
        if (
          !formatSelect ||
          !thirdPlaceRow ||
          !groupConfigSection ||
          !groupConfigHeader
        ) {
          console.warn(
            "DEBUG (addseason): Missing elements for format toggle UI."
          );
          return;
        }

        const selectedFormatValue = formatSelect.value; // Lấy VALUE từ select
        const isChiaBang = selectedFormatValue === "group_knockout"; // So sánh với VALUE
        // *******************************
        thirdPlaceRow.style.display = isChiaBang ? "flex" : "none"; // Dùng flex như HTML gốc
        groupConfigSection.style.display = isChiaBang ? "block" : "none";
        groupConfigHeader.style.display = isChiaBang ? "block" : "none";
        console.log(
          `DEBUG (addseason): Format selected: ${selectedFormatValue}, ChiaBang sections visible: ${isChiaBang}`
        );
      }
      // Gọi lần đầu và thêm listener (nếu formatSelect tồn tại)
      if (formatSelect) {
        updateUIBasedOnFormat();
        formatSelect.addEventListener("change", updateUIBasedOnFormat);
      }

      // --- XỬ LÝ NÚT LƯU MÙA GIẢI ---
      if (saveBtn && tenMuaGiaiInput && soDoiThamDuInput) {
        saveBtn.addEventListener("click", function (e) {
          e.preventDefault();
          if (successMsg) successMsg.style.display = "none";

          if (currentLeagueId === null) {
            alert("Lỗi: Không xác định được Giải đấu.");
            return;
          }

          const tenMuaGiaiValue = tenMuaGiaiInput.value.trim();
          const soDoiThamDuValue = soDoiThamDuInput.value;

          if (tenMuaGiaiValue === "" || soDoiThamDuValue === "") {
            alert("Vui lòng nhập Tên mùa giải và Số đội!");
            return;
          }

          console.log("DEBUG (addseason): Validation passed.");

          // --- Lấy TẤT CẢ giá trị từ form (Dùng ID) ---
          const newSeasonData = {
            id: Date.now(),
            leagueId: currentLeagueId,
            name: tenMuaGiaiValue,
            startDate: thoiGianBatDauInput?.value || null,
            endDate: thoiGianKetThucInput?.value || null,
            teamCount: soDoiThamDuValue ? parseInt(soDoiThamDuValue) : null,
            matchFormat: formatSelect?.value || null, // Lấy VALUE
            roundRobinTurns: roundRobinTurnsSelect?.value
              ? parseInt(roundRobinTurnsSelect.value)
              : null, // Lấy VALUE
            pointsWin:
              pointsWinInput?.value !== "" ? parseInt(pointsWinInput.value) : 3,
            pointsDraw:
              pointsDrawInput?.value !== ""
                ? parseInt(pointsDrawInput.value)
                : 1,
            pointsLoss:
              pointsLossInput?.value !== ""
                ? parseInt(pointsLossInput.value)
                : 0,
            hasBronzeMatch: hasBronzeMatchToggle?.checked || false,
            maxPlayers: maxPlayersInput?.value
              ? parseInt(maxPlayersInput.value)
              : null,
            maxStaff: maxStaffInput?.value
              ? parseInt(maxStaffInput.value)
              : null,
            numberOfHalves: numberOfHalvesInput?.value
              ? parseInt(numberOfHalvesInput.value)
              : 2,
            halfTimeDuration: halfTimeDurationInput?.value
              ? parseInt(halfTimeDurationInput.value)
              : null,
            groupCount: groupCountInput?.value
              ? parseInt(groupCountInput.value)
              : null,
            teamsFromGroup1st: teamsFromGroup1stInput?.value
              ? parseInt(teamsFromGroup1stInput.value)
              : null,
            teamsFromGroup2nd: teamsFromGroup2ndInput?.value
              ? parseInt(teamsFromGroup2ndInput.value)
              : null,
            teamsFromGroup3rd: teamsFromGroup3rdInput?.value
              ? parseInt(teamsFromGroup3rdInput.value)
              : null,
            teamsFromGroup4th: teamsFromGroup4thInput?.value
              ? parseInt(teamsFromGroup4thInput.value)
              : null,
            location: locationInput?.value.trim() || null,
            fanpage: fanpageInput?.value.trim() || null,
            logo: logoDataUrl,
            wallpaper: wpDataUrl,
            createdAt: new Date().toISOString(),
          };

          // --- Lưu vào localStorage ---
          try {
            const storageKey = "danhSachMuaGiai";
            let seasons = JSON.parse(localStorage.getItem(storageKey)) || [];
            seasons.push(newSeasonData);
            localStorage.setItem(storageKey, JSON.stringify(seasons));
            console.log(
              `DEBUG (addseason): Season saved ID: ${newSeasonData.id}.`
            );

            if (successMsg) {
              successMsg.textContent = "Thêm mùa giải thành công!";
              successMsg.style.display = "block";
            } else {
              alert("Thêm mùa giải thành công!");
            }
          } catch (error) {
            console.error("DEBUG (addseason): Error saving season:", error);
            alert("Lỗi khi lưu mùa giải.");
          }
        });
      } else {
        console.error("DEBUG (addseason): Missing core save elements.");
      }
    </script>
  </body>
</html>
